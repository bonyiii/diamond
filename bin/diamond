#!/usr/bin/env ruby
# encoding: UTF-8

require 'rubygems'
require 'commander/import'
require 'yaml'
require 'json'

require 'rack'
require "pathname"
require 'coffee-script'
require 'haml'
require 'sass'
require 'rack'
require 'renee'
require 'thin'
require 'rake'
require 'hpricot'

require_relative '../lib/builder'
require_relative '../lib/app'
require_relative '../lib/extensions'
require_relative '../lib/server'

program :name, 'Shard CLI'
program :version, '0.0.1'
program :description, 'Shard CLI'

global_option('-e', '--env STRING', 'Rnvirnoment') { |env| $env = env }

bin_file = Pathname.new(__FILE__).realpath
$:.unshift File.expand_path("../../lib", bin_file)
$dirname = File.dirname(File.expand_path(File.dirname bin_file))

$env = 'development' unless $env

$app = App.new
$app.load_config

command :nw do |c|
  c.syntax = ''
  c.description = ''
  c.action do |args,options|
    $app.build_node_webkit
  end
end

command :server do |c|
  c.action do |args,options|
    statics = Dir.glob($app.assets_dir+"/*/").map {|dir| "/"+File.basename(dir)}
    builder = Rack::Builder.new {
      use Rack::Static, :urls => statics, :root => $app.assets_dir
      run Server
    }
    Rack::Handler::Thin.run builder, :Port => 9292
  end
end

command :specs do |c|
  $app.compile_specs
  c.action do |args,options|
    job1 = 0
    silence_stream(STDOUT) do
      job1 = fork do
        statics = Dir.glob($app.assets_dir+"/*/").map {|dir| "/"+File.basename(dir)}
        builder = Rack::Builder.new {
          use Rack::Static, :urls => statics, :root => $app.assets_dir
          run Server
        }
        Rack::Handler::Thin.run builder, :Port => 5000
      end
    end
    sleep 5
    Process.detach(job1)
    puts `phantomjs #{$dirname+"/assets/script.coffee"} http://localhost:5000/specs`
    Process.kill "KILL", job1
  end

end

command :build do |c|
  c.syntax = ''
  c.description = ''
  c.action do |args,options|
    $app.build app.build_dir
  end
end