#!/usr/bin/env ruby
# encoding: UTF-8

require 'rubygems'
require 'commander/import'
require 'yaml'
require 'json'

require 'rack'
require "pathname"
require 'coffee-script'
require 'haml'
require 'sass'
require 'rack'
require 'renee'
require 'thin'
require 'rake'
require 'hpricot'
require 'zip/zip'

require_relative '../lib/builder'
require_relative '../lib/app'
require_relative '../lib/extensions'
require_relative '../lib/server'

program :name, 'Diamond'
program :version, '0.0.1'
program :description, ' Development Enviroment for Chrome / Node-Webkit apps'

global_option('-e', '--env STRING', 'envirnoment') { |env| $env = env }

bin_file = Pathname.new(__FILE__).realpath
$:.unshift File.expand_path("../../lib", bin_file)
$dirname = File.dirname(File.expand_path(File.dirname bin_file))

$env = 'development' unless $env

$app = App.new
$app.load_config

command :nw do |c|
  c.syntax = ''
  c.description = ''
  c.action do |args,options|
    $app.run_node_webkit
  end
end

command :server do |c|
  c.action do |args,options|
    statics = Dir.glob($app.assets_dir+"/*/").map {|dir| "/"+File.basename(dir)}
    builder = Rack::Builder.new {
      use Rack::Static, :urls => statics, :root => $app.assets_dir
      run Server
    }
    Rack::Handler::Thin.run builder, :Port => 9292
  end
end

command :specs do |c|
  $app.compile_specs
  c.action do |args,options|
    job1 = 0
    silence_stream(STDOUT) do
      job1 = fork do
        statics = Dir.glob($app.assets_dir+"/*/").map {|dir| "/"+File.basename(dir)}
        builder = Rack::Builder.new {
          use Rack::Static, :urls => statics, :root => $app.assets_dir
          run Server
        }
        Rack::Handler::Thin.run builder, :Port => 5000
      end
    end
    sleep 5
    Process.detach(job1)
    puts `phantomjs #{$dirname+"/assets/script.coffee"} http://localhost:5000/specs`
    Process.kill "KILL", job1
  end

end

command :build do |c|
  c.syntax = ''
  c.description = ''
  c.action do |args,options|
    $app.build app.build_dir
  end
end

command :cleanup do |c|
  c.action do |args,options|
    `rm -rf app.nw .nw_build .build packages/linux32 packages/linux64 packages/win32 packages/mac32`
  end
end

command :package do |c|
  c.action do |args,options|

    `rm -rf packages`
    `mkdir packages`
    puts "Packaging for Chrome Web Store"
    $app.build_chrome
    `cd .build && zip -r ../packages/chrome_web_store.zip *`


    puts "Packaging for Platforms:"

    $app.build_node_webkit

    Zip::ZipFile.open('app.nw',Zip::ZipFile::CREATE) do |zip|
      Dir.glob(".nw_build/**/*") do |file|
        zip.add file.gsub('.nw_build/',''), file
      end
    end

    `cp -r #{$app.config[:node_webkit_directory]}/* packages/`
    puts "  > Linux 32bit"
    `cat packages/linux32/nw app.nw > packages/linux32/#{$app.config[:app][:title].downcase} && chmod +x packages/linux32/#{$app.config[:app][:title].downcase}`
    `rm -f packages/linux32/nw`
    puts "  > Linux 64bit"
    `cat packages/linux64/nw app.nw > packages/linux64/#{$app.config[:app][:title].downcase} && chmod +x packages/linux64/#{$app.config[:app][:title].downcase}`
    `rm -f packages/linux64/nw`
    puts "  > Windows 32bit"
    `cat packages/win32/nw.exe app.nw > packages/win32/#{$app.config[:app][:title].downcase}.exe`
    `rm -f packages/win32/nw.exe`
    puts "  > Mac 32bit"
    `cp app.nw packages/mac32/node-webkit.app/Contents/Resources/app.nw`

    puts "Zipping packages:"
    puts "  > Linux 32bit"
    `cd packages/linux32 && zip -r ../#{$app.config[:app][:title].downcase}-linux32.zip *`
    puts "  > Linux 64bit"
    `cd packages/linux64 && zip -r ../#{$app.config[:app][:title].downcase}-linux64.zip *`
    puts "  > Windows 32bit"
    `cd packages/win32 && zip -r ../#{$app.config[:app][:title].downcase}-win32.zip *`
    puts "  > Mac 32bit"
    `cd packages/mac32/ && mv node-webkit.app #{$app.config[:app][:title].downcase}.app && zip -r ../#{$app.config[:app][:title].downcase}-mac32.zip *`
    puts "Cleaning up"
    `rm -rf app.nw .nw_build .build packages/linux32 packages/linux64 packages/win32 packages/mac32`
  end
end